#include <iostream>
#include <string>
#include <cstdlib>
#include <limits>
#include <iomanip>
#include <functional>
#include "DatabaseService.h"
#include "ApiService.h"
#include "ConfigManager.h"
#include "LocaleManager.h"

#ifdef _WIN32
#include <windows.h>
#define CLEAR_SCREEN "cls"
#else
#define CLEAR_SCREEN "clear"
#endif

class Application {
private:
    DatabaseService dbService;
    ApiService apiService;
    ConfigManager configManager;
    bool apiRunning = false;
    std::map<std::string, std::string> locale;
    
    static const int MENU_WIDTH = 60;

public:
    Application(const std::map<std::string, std::string>& loc) : apiService(dbService), locale(loc) {}

    std::string tr(const std::string& key) {
        auto it = locale.find(key);
        if (it != locale.end()) {
            return it->second;
        }
        return key;
    }

    void clearScreen() {
        system(CLEAR_SCREEN);
    }

    void drawHeader(const std::string& title) {
        std::cout << "============================================================" << std::endl;
        std::cout << "                     " << title << std::endl;
        std::cout << "============================================================" << std::endl << std::endl;
    }

    void drawSeparator() {
        std::cout << "------------------------------------------------------------" << std::endl;
    }

    void showMainMenu() {
        while (true) {
            clearScreen();
            drawHeader(tr("app_title"));
            
            // Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
            std::cout << "ðŸ“Š " << tr("system_status") << ":" << std::endl;
            std::cout << "   ðŸ—„ï¸  " << tr("database") << ": " << (dbService.testConnection() ? "âœ… " + tr("connected") : "âŒ " + tr("disconnected")) << std::endl;
            std::cout << "   ðŸŒ " << tr("api_server") << ": " << (apiRunning ? "âœ… " + tr("running") : "âŒ " + tr("stopped")) << std::endl;
            
            DatabaseConfig config = dbService.getCurrentConfig();
            std::cout << "   ðŸŒ " << tr("language") << ": " << (config.language == "en" ? "English" : "Ð ÑƒÑÑÐºÐ¸Ð¹") << std::endl;
            
            std::cout << std::endl;
            drawSeparator();
            std::cout << "ðŸ“‹ " << tr("main_menu") << ":" << std::endl;
            std::cout << std::endl;
            
            // ÐŸÑƒÐ½ÐºÑ‚Ñ‹ Ð¼ÐµÐ½ÑŽ
            std::cout << " 1. âš™ï¸  " << tr("menu_db_setup") << std::endl;
            std::cout << " 2. ðŸŒ " << tr("menu_api_manage") << std::endl;
            std::cout << " 3. ðŸ‘¥ " << tr("menu_students") << std::endl;
            std::cout << " 4. ðŸ‘¨â€ðŸ« " << tr("menu_teachers") << std::endl;
            std::cout << " 5. ðŸŽ¯ " << tr("menu_groups") << std::endl;
            std::cout << " 6. ðŸ“ " << tr("menu_portfolios") << std::endl;
            std::cout << " 7. â„¹ï¸  " << tr("menu_system_info") << std::endl;
            std::cout << " 8. ðŸŒ " << tr("menu_change_language") << std::endl;
            std::cout << std::endl;
            std::cout << " Q. ðŸšª " << tr("menu_exit") << std::endl;
            std::cout << std::endl;
            
            std::cout << "ðŸŽ¯ " << tr("choose_option") << ": ";
            std::string choice;
            std::cin >> choice;
            std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');
            
            if (choice == "1") {
                setupDatabase();
            } else if (choice == "2") {
                manageApi();
            } else if (choice == "3") {
                manageStudents();
            } else if (choice == "4") {
                manageTeachers();
            } else if (choice == "5") {
                manageGroups();
            } else if (choice == "6") {
                managePortfolios();
            } else if (choice == "7") {
                showSystemInfo();
            } else if (choice == "8") {
                changeLanguage();
            } else if (choice == "Q" || choice == "q") {
                exitApplication();
                break;
            } else {
                showError(tr("invalid_choice"));
            }
        }
    }

private:
    void setupDatabase() {
        clearScreen();
        drawHeader(tr("db_config_title"));

        DatabaseConfig currentConfig = dbService.getCurrentConfig();
        
        std::cout << "ðŸ“„ " << tr("current_settings") << ":" << std::endl;
        std::cout << "   ðŸ“ " << tr("host") << ": " << currentConfig.host << std::endl;
        std::cout << "   ðŸšª " << tr("port") << ": " << currentConfig.port << std::endl;
        std::cout << "   ðŸ—„ï¸  " << tr("database_name") << ": " << currentConfig.database << std::endl;
        std::cout << "   ðŸ‘¤ " << tr("username") << ": " << currentConfig.username << std::endl;
        std::cout << "   ðŸ”’ " << tr("password") << ": " << std::string(currentConfig.password.length(), '*') << std::endl;
        
        std::cout << std::endl << "ðŸ”„ " << tr("change_settings") << "? (y/N): ";
        std::string change;
        std::getline(std::cin, change);
        
        if (change == "y" || change == "Y" || change == "Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽ" || change == "Ð´Ð°") {
            std::cout << std::endl << "âœï¸  " << tr("enter_new_settings") << ":" << std::endl;
            
            std::cout << "   " << tr("host") << " [" << currentConfig.host << "]: ";
            std::string host;
            std::getline(std::cin, host);
            if (!host.empty()) currentConfig.host = host;

            std::cout << "   " << tr("port") << " [" << currentConfig.port << "]: ";
            std::string portStr;
            std::getline(std::cin, portStr);
            if (!portStr.empty()) currentConfig.port = std::stoi(portStr);

            std::cout << "   " << tr("database_name") << " [" << currentConfig.database << "]: ";
            std::string db;
            std::getline(std::cin, db);
            if (!db.empty()) currentConfig.database = db;

            std::cout << "   " << tr("username") << " [" << currentConfig.username << "]: ";
            std::string user;
            std::getline(std::cin, user);
            if (!user.empty()) currentConfig.username = user;

            std::cout << "   " << tr("password") << ": ";
            std::string pass;
            std::getline(std::cin, pass);
            if (!pass.empty()) currentConfig.password = pass;

            configManager.saveConfig(currentConfig);
            std::cout << std::endl << "âœ… " << tr("settings_saved") << std::endl;
        }

        std::cout << std::endl << "ðŸ” " << tr("testing_connection") << "..." << std::endl;
        if (dbService.testConnection()) {
            std::cout << "âœ… " << tr("connection_success") << std::endl;
            std::cout << "âš™ï¸  " << tr("setting_up_tables") << "..." << std::endl;
            if (dbService.setupDatabase()) {
                std::cout << "âœ… " << tr("db_setup_success") << std::endl;
            } else {
                showError(tr("db_setup_error"));
            }
        } else {
            showError(tr("connection_error"));
            std::cout << "ðŸ’¡ " << tr("check_settings") << std::endl;
        }

        waitForEnter();
    }

    void manageApi() {
        clearScreen();
        drawHeader(tr("api_manage_title"));
        
        if (!apiRunning) {
            std::cout << "ðŸ” " << tr("checking_db") << "..." << std::endl;
            if (dbService.testConnection()) {
                std::cout << "âœ… " << tr("db_available") << std::endl;
                std::cout << "ðŸš€ " << tr("starting_api") << "..." << std::endl;
                
                if (apiService.start()) {
                    apiRunning = true;
                    std::cout << std::endl << "ðŸŽ‰ " << tr("api_start_success") << std::endl;
                    std::cout << "ðŸ“ " << tr("available_at") << ": http://localhost:5000" << std::endl;
                    std::cout << std::endl << "ðŸ“¡ " << tr("available_endpoints") << ":" << std::endl;
                    std::cout << "   ðŸ‘¥ GET /students   - " << tr("menu_students") << std::endl;
                    std::cout << "   ðŸ‘¨â€ðŸ« GET /teachers  - " << tr("menu_teachers") << std::endl;
                    std::cout << "   ðŸŽ¯ GET /groups     - " << tr("menu_groups") << std::endl;
                } else {
                    showError(tr("api_start_error"));
                }
            } else {
                showError(tr("db_unavailable"));
                std::cout << "ðŸ’¡ " << tr("setup_db_first") << std::endl;
            }
        } else {
            apiService.stop();
            apiRunning = false;
            std::cout << "âœ… " << tr("api_stop_success") << std::endl;
        }

        waitForEnter();
    }

    void changeLanguage() {
        clearScreen();
        drawHeader(tr("language_selection"));
        
        std::cout << "ðŸŒ " << tr("select_language") << ":" << std::endl;
        std::cout << "  1. English" << std::endl;
        std::cout << "  2. Ð ÑƒÑÑÐºÐ¸Ð¹" << std::endl;
        std::cout << std::endl << "ðŸŽ¯ " << tr("choose_option") << ": ";
        
        std::string choice;
        std::cin >> choice;
        std::cin.ignore(std::numeric_limits<std::streamsize>::max(), '\n');
        
        std::string newLanguage;
        if (choice == "1") {
            newLanguage = "en";
        } else if (choice == "2") {
            newLanguage = "ru";
        } else {
            showError(tr("invalid_choice"));
            waitForEnter();
            return;
        }
        
        locale = LocaleManager::loadLocale(newLanguage);
        DatabaseConfig config = dbService.getCurrentConfig();
        config.language = newLanguage;
        configManager.saveConfig(config);
        
        showSuccess(tr("language_changed"));
        waitForEnter();
    }

    void manageStudents() {
        clearScreen();
        drawHeader(tr("students_manage_title"));

        auto students = dbService.getStudents();
        
        std::cout << "ðŸ“Š " << tr("total_students") << ": " << students.size() << std::endl;
        std::cout << std::endl;
        
        if (!students.empty()) {
            // ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð±ÐµÐ· ÑÐ»Ð¾Ð¶Ð½Ð¾Ð³Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
            std::cout << "======================================================================================================================" << std::endl;
            std::cout << std::setw(12) << std::left << tr("student_code")
                      << std::setw(20) << std::left << tr("last_name")
                      << std::setw(20) << std::left << tr("first_name")
                      << std::setw(20) << std::left << tr("middle_name")
                      << std::setw(16) << std::left << tr("phone")
                      << std::setw(25) << std::left << tr("email")
                      << std::setw(10) << std::left << tr("group") << std::endl;
            std::cout << "======================================================================================================================" << std::endl;
            
            for (const auto& student : students) {
                std::cout << std::setw(12) << std::left << student.studentCode
                          << std::setw(20) << std::left << truncateString(student.lastName, 18)
                          << std::setw(20) << std::left << truncateString(student.firstName, 18)
                          << std::setw(20) << std::left << truncateString(student.middleName, 18)
                          << std::setw(16) << std::left << student.phoneNumber
                          << std::setw(25) << std::left << truncateString(student.email, 23)
                          << std::setw(10) << std::left << student.groupId << std::endl;
            }
            
            std::cout << "======================================================================================================================" << std::endl;
        } else {
            std::cout << "ðŸ“­ " << tr("no_students") << std::endl;
        }

        std::cout << std::endl << "ðŸ’¡ " << tr("use_api_hint") << std::endl;
        waitForEnter();
    }

    void manageTeachers() {
        clearScreen();
        drawHeader(tr("teachers_manage_title"));

        auto teachers = dbService.getTeachers();
        
        std::cout << "ðŸ“Š " << tr("total_teachers") << ": " << teachers.size() << std::endl;
        std::cout << std::endl;
        
        if (!teachers.empty()) {
            std::cout << "==========================================================================================================" << std::endl;
            std::cout << std::setw(12) << std::left << tr("teacher_id")
                      << std::setw(20) << std::left << tr("last_name")
                      << std::setw(20) << std::left << tr("first_name")
                      << std::setw(12) << std::left << tr("experience")
                      << std::setw(20) << std::left << tr("specialization")
                      << std::setw(25) << std::left << tr("email") << std::endl;
            std::cout << "==========================================================================================================" << std::endl;
            
            for (const auto& teacher : teachers) {
                std::cout << std::setw(12) << std::left << teacher.teacherId
                          << std::setw(20) << std::left << truncateString(teacher.lastName, 18)
                          << std::setw(20) << std::left << truncateString(teacher.firstName, 18)
                          << std::setw(12) << std::left << teacher.experience
                          << std::setw(20) << std::left << truncateString(teacher.specialization, 18)
                          << std::setw(25) << std::left << truncateString(teacher.email, 23) << std::endl;
            }
            
            std::cout << "==========================================================================================================" << std::endl;
        } else {
            std::cout << "ðŸ“­ " << tr("no_teachers") << std::endl;
        }

        waitForEnter();
    }

    void manageGroups() {
        clearScreen();
        drawHeader(tr("groups_manage_title"));

        auto groups = dbService.getGroups();
        
        std::cout << "ðŸ“Š " << tr("total_groups") << ": " << groups.size() << std::endl;
        std::cout << std::endl;
        
        if (!groups.empty()) {
            std::cout << "==========================================================" << std::endl;
            std::cout << std::setw(12) << std::left << tr("group_id")
                      << std::setw(26) << std::left << tr("group_name")
                      << std::setw(18) << std::left << tr("student_count")
                      << std::setw(14) << std::left << tr("teacher_id") << std::endl;
            std::cout << "==========================================================" << std::endl;
            
            for (const auto& group : groups) {
                std::cout << std::setw(12) << std::left << group.groupId
                          << std::setw(26) << std::left << truncateString(group.name, 24)
                          << std::setw(18) << std::left << group.studentCount
                          << std::setw(14) << std::left << group.teacherId << std::endl;
            }
            
            std::cout << "==========================================================" << std::endl;
        } else {
            std::cout << "ðŸ“­ " << tr("no_groups") << std::endl;
        }

        waitForEnter();
    }

    void managePortfolios() {
        clearScreen();
        drawHeader(tr("portfolios_manage_title"));

        auto portfolios = dbService.getPortfolios();
        
        std::cout << "ðŸ“Š " << tr("total_portfolios") << ": " << portfolios.size() << std::endl;
        std::cout << std::endl;
        
        if (!portfolios.empty()) {
            std::cout << "==========================================================================================" << std::endl;
            std::cout << std::setw(16) << std::left << tr("portfolio_id")
                      << std::setw(16) << std::left << tr("student_id")
                      << std::setw(22) << std::left << tr("measure_code")
                      << std::setw(14) << std::left << tr("date")
                      << std::setw(18) << std::left << tr("passport_series")
                      << std::setw(18) << std::left << tr("passport_number") << std::endl;
            std::cout << "==========================================================================================" << std::endl;
            
            for (const auto& portfolio : portfolios) {
                std::cout << std::setw(16) << std::left << portfolio.portfolioId
                          << std::setw(16) << std::left << portfolio.studentCode
                          << std::setw(22) << std::left << truncateString(portfolio.measureCode, 20)
                          << std::setw(14) << std::left << portfolio.date
                          << std::setw(18) << std::left << portfolio.passportSeries
                          << std::setw(18) << std::left << portfolio.passportNumber << std::endl;
            }
            
            std::cout << "==========================================================================================" << std::endl;
        } else {
            std::cout << "ðŸ“­ " << tr("no_portfolios") << std::endl;
        }

        waitForEnter();
    }

    void showSystemInfo() {
        clearScreen();
        drawHeader(tr("system_info_title"));
        
        std::cout << "============================================================" << std::endl;
        std::cout << "              Student Management System v1.0" << std::endl;
        std::cout << "============================================================" << std::endl;
        std::cout << "ðŸŽ¯ " << tr("app_title") << std::endl;
        std::cout << "ðŸ–¥ï¸  Platform: Windows/Linux" << std::endl;
        std::cout << "ðŸ—„ï¸  Database: PostgreSQL 12+" << std::endl;
        std::cout << "ðŸ’» Programming Language: C++17" << std::endl;
        std::cout << std::endl;
        std::cout << "ðŸ“š Used Libraries:" << std::endl;
        std::cout << "   â€¢ libpq (PostgreSQL client)" << std::endl;
        std::cout << "   â€¢ nlohmann/json (JSON processing)" << std::endl;
        std::cout << std::endl;
        std::cout << "ðŸš€ Main Features:" << std::endl;
        std::cout << "   â€¢ " << tr("menu_students") << std::endl;
        std::cout << "   â€¢ " << tr("menu_teachers") << std::endl;
        std::cout << "   â€¢ " << tr("menu_groups") << std::endl;
        std::cout << "   â€¢ " << tr("menu_portfolios") << std::endl;
        std::cout << "   â€¢ REST API for integration" << std::endl;
        std::cout << "   â€¢ Cross-platform" << std::endl;
        std::cout << std::endl;
        std::cout << "ðŸ“ž Developer: Dmitry Stolbov" << std::endl;
        std::cout << "============================================================" << std::endl;

        waitForEnter();
    }

    void exitApplication() {
        clearScreen();
        drawHeader(tr("exit_title"));
        
        if (apiRunning) {
            std::cout << "ðŸ›‘ " << tr("stopping_api") << "..." << std::endl;
            apiService.stop();
            apiRunning = false;
            std::cout << "âœ… " << tr("api_stop_success") << std::endl;
        }
        
        std::cout << std::endl << "ðŸ‘‹ " << tr("thank_you") << std::endl;
        std::cout << std::endl;
    }

    void waitForEnter() {
        std::cout << std::endl << "â†µ " << tr("press_enter") << std::endl;
        std::cin.get();
    }

    void showError(const std::string& message) {
        std::cout << "âŒ " << tr("error") << ": " << message << std::endl;
    }

    void showSuccess(const std::string& message) {
        std::cout << "âœ… " << message << std::endl;
    }

    std::string truncateString(const std::string& str, size_t maxLength) {
        if (str.length() <= maxLength) {
            return str;
        }
        return str.substr(0, maxLength - 3) + "...";
    }
};

int main() {
#ifdef _WIN32
    SetConsoleOutputCP(65001);
    SetConsoleCP(65001);
#endif

    try {
        std::cout << "ðŸŒ Checking localization files..." << std::endl;
        if (!LocaleManager::checkLocales()) {
            std::cout << "âŒ Localization files missing. Please make sure lang/locale_en.json and lang/locale_ru.json exist." << std::endl;
            return 1;
        }

        ConfigManager configManager;
        DatabaseConfig config;
        configManager.loadConfig(config);
        
        std::map<std::string, std::string> currentLocale = LocaleManager::loadLocale(config.language);
        
        if (currentLocale.empty()) {
            std::cerr << "âŒ Failed to load localization for language: " << config.language << std::endl;
            return 1;
        }

        std::cout << std::endl << "ðŸš€ Starting application..." << std::endl;
        std::this_thread::sleep_for(std::chrono::seconds(1));

        Application app(currentLocale);
        app.showMainMenu();
    } catch (const std::exception& e) {
        std::cerr << "ðŸ’¥ Critical error: " << e.what() << std::endl;
        std::cout << "Press Enter to exit..." << std::endl;
        std::cin.get();
        return 1;
    }

    return 0;
}